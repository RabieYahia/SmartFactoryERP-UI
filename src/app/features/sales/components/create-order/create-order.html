<div class="container">
  <h2>üí∞ New Sales Order</h2>

  <form [formGroup]="orderForm" (ngSubmit)="onSubmit()" class="order-form">
    
    <div class="form-section">
      <div class="form-group">
        <label>Customer:</label>
        <select formControlName="customerId">
          <option value="">-- Select Customer --</option>
          @for (cust of customers(); track cust.id) {
            <option [value]="cust.id">{{ cust.customerName }} (Limit: {{ cust.creditLimit | currency }})</option>
          }
        </select>
      </div>
    </div>

    <div class="form-section">
      <div class="section-header">
        <h3>Order Items</h3>
        <button type="button" class="btn-add" (click)="addItem()">+ Add Product</button>
      </div>

      <table class="items-table">
        <thead>
          <tr>
            <th>Product</th>
            <th width="100">Qty</th>
            <th width="150">Unit Price</th>
            <th width="100">Total</th>
            <th width="50"></th>
          </tr>
        </thead>
        <tbody formArrayName="items">
          @for (item of itemsArray.controls; track $index) {
            <tr [formGroupName]="$index">
              <td>
                <select formControlName="materialId">
                  <option value="">-- Select Product --</option>
                  @for (mat of materials(); track mat.id) {
                    <option [value]="mat.id">
                      {{ mat.materialName }} (Stock: {{ mat.currentStockLevel }})
                    </option>
                  }
                </select>
              </td>
              <td>
                <input type="number" formControlName="quantity" min="1">
              </td>
              <td>
                <input type="number" formControlName="unitPrice" min="0">
              </td>
              <td>
                {{ (item.get('quantity')?.value * item.get('unitPrice')?.value) | currency }}
              </td>
              <td>
                <button type="button" class="btn-remove" (click)="removeItem($index)">üóëÔ∏è</button>
              </td>
            </tr>
          }
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" style="text-align: right;">Grand Total:</td>
            <td style="font-weight: bold; color: green;">{{ totalAmount | currency }}</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="actions">
      <button type="button" class="btn-secondary" routerLink="/sales">Cancel</button>
      <button type="submit" class="btn-primary" [disabled]="isSubmitting()">
        @if (isSubmitting()) { Processing... } @else { üíæ Save Order }
      </button>
    </div>

  </form>
</div>