<div class="container-fluid p-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h3 fw-bold text-primary mb-1">ðŸ“œ Define Production Recipe (BOM)</h2>
      <p class="text-muted small">Link raw materials to a finished product.</p>
    </div>
    <button class="btn btn-outline-secondary" routerLink="/production">
      <i class="bi bi-arrow-left me-2"></i> Back to Dashboard
    </button>
  </div>

  <form [formGroup]="bomForm" (ngSubmit)="onSubmit()">

    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <h6 class="mb-0 fw-bold d-flex align-items-center">
          <span class="badge-number">1</span> Select Finished Product
        </h6>
      </div>
      <div class="card-body">
        <label class="form-label text-muted small fw-bold">PRODUCT TO PRODUCE</label>
        <select class="form-select form-select-lg" formControlName="productId"
          [class.is-invalid]="bomForm.get('productId')?.invalid && bomForm.get('productId')?.touched">
          <option [ngValue]="null" disabled selected>-- Choose Finished Good --</option>

          @for (prod of finishedProducts(); track prod.id) {
            <option [ngValue]="prod.id">{{ prod.materialName }} (Code: {{ prod.materialCode }})</option>
          }
        </select>
        @if (bomForm.get('productId')?.invalid && bomForm.get('productId')?.touched) {
          <div class="text-danger small mt-1">Please select a product.</div>
        }
      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold d-flex align-items-center">
          <span class="badge-number">2</span> Raw Materials Recipe
        </h6>
        <button type="button" class="btn btn-sm btn-primary" (click)="addComponent()">
          <i class="bi bi-plus-lg me-1"></i> Add Component
        </button>
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="bg-light">
              <tr>
                <th style="width: 50%;" class="ps-4">Raw Material</th>
                <th style="width: 30%;">Quantity Required</th>
                <th style="width: 20%;" class="text-center">Action</th>
              </tr>
            </thead>
            <tbody formArrayName="components">
              @for (comp of componentsArr.controls; track $index) {
                <tr [formGroupName]="$index">
                  <td class="ps-4">
                    <select class="form-select" formControlName="componentId"
                      [class.is-invalid]="comp.get('componentId')?.invalid && comp.get('componentId')?.touched"
                      (change)="onComponentSelected($index, comp.get('componentId')?.value)">
                      <option [ngValue]="null" disabled selected>-- Select Material --</option>

                      @for (mat of rawMaterials(); track mat.id) {
                        <option [ngValue]="mat.id" [disabled]="isComponentAlreadyAdded(mat.id, $index)">
                          {{ mat.materialName }}
                        </option>
                      }
                    </select>
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="number" class="form-control" formControlName="quantity" min="0.1" step="0.1" placeholder="Qty">
                      <span class="input-group-text bg-light text-muted">Units</span>
                    </div>
                  </td>
                  <td class="text-center">
                    <button type="button" class="btn btn-link text-danger p-0" (click)="removeComponent($index)" title="Remove">
                      <i class="bi bi-trash-fill fs-5"></i>
                    </button>
                  </td>
                </tr>
              }
              @empty {
                <tr>
                  <td colspan="3" class="text-center py-5 text-muted">
                    <i class="bi bi-basket fs-1 d-block mb-2 text-secondary opacity-50"></i>
                    No components added yet. Click "Add Component" to start.
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <button type="button" class="btn btn-lg btn-light border px-4" routerLink="/production">Cancel</button>
      <button type="submit" class="btn btn-lg btn-success px-5"
        [disabled]="bomForm.invalid || componentsArr.length === 0 || isSubmitting()">
        @if (isSubmitting()) {
          <span class="spinner-border spinner-border-sm me-2"></span> Saving...
        } @else {
          <i class="bi bi-check-lg me-2"></i> Save Recipe
        }
      </button>
    </div>

  </form>
</div>
